package life.genny.rules;
import life.genny.qwanda.message.QDataAnswerMessage;
import life.genny.models.GennyToken;
import life.genny.rules.QRules;
import life.genny.utils.BaseEntityUtils;
import life.genny.qwanda.Answer;
import io.vertx.core.json.JsonObject;
import java.util.Map;
import java.util.HashMap;
import java.lang.reflect.Type;
import java.util.ArrayList;
import java.util.List;
import com.google.gson.reflect.TypeToken;
import life.genny.qwandautils.JsonUtils;
import life.genny.utils.VertxUtils;
import life.genny.utils.TableUtils;
import life.genny.models.TableData;
import life.genny.qwanda.message.QDataBaseEntityMessage;
import life.genny.qwanda.entity.BaseEntity;
import life.genny.qwanda.Ask;
import life.genny.qwanda.message.QDataAskMessage;
import  life.genny.utils.OutputParam;


import java.util.List;
import java.util.ArrayList;

rule "PRI_SEARCH_TEXT"
    ruleflow-group 'AnswerProcessing'
        salience 500 
    when
      beUtils : BaseEntityUtils()
	  serviceToken : GennyToken( code == "PER_SERVICE") 
	  answer : Answer( attributeCode == "PRI_SEARCH_TEXT" )
	  output : OutputParam( )
	  
     then
  		System.out.println("Rule -> "+drools.getRule().getName()+" :  user=" + beUtils.getGennyToken().getUserCode()+" : "+answer); 
		String sourceCode = beUtils.getGennyToken().getUserCode();
		String targetCode = answer.getTargetCode();
		
		/* Perform a search bar search */
		String searchBarString = answer.getValue();
		searchBarString = searchBarString.trim();
		System.out.println("Search text = ["+searchBarString+"]");
		
		/* fetch Session SearchBar List from User */
		BaseEntity user = VertxUtils.getObject(beUtils.getGennyToken().getRealm(), "", beUtils.getGennyToken().getUserCode(),
				BaseEntity.class, beUtils.getGennyToken().getToken());
		Type type = new TypeToken<List<String>>() {}.getType();
		List<String> defaultList = new ArrayList<String>();
		String defaultListString = JsonUtils.toJson(defaultList);
		String historyStr = user.getValue("PRI_SEARCH_HISTORY",defaultListString);
		List<String> searchHistory = JsonUtils.fromJson(historyStr, type);
		
		/* Add new SearchBarString to Session SearchBar List */
		searchHistory.add(0, searchBarString);
		String newHistoryString = JsonUtils.toJson(searchHistory);
		Answer history = new Answer(beUtils.getGennyToken().getUserCode(),beUtils.getGennyToken().getUserCode(),"PRI_SEARCH_HISTORY",newHistoryString);
		beUtils.saveAnswer(history);
		
		String searchBarCode = "SBE_SEARCHBAR";
		
		String sessionSearchCode = searchBarCode+"_"+beUtils.getGennyToken().getSessionCode();
		SearchEntity searchBE = VertxUtils.getObject(serviceToken.getRealm(), "", sessionSearchCode, SearchEntity.class,serviceToken.getToken());
		
		if (searchBE == null) {
			searchBE = VertxUtils.getObject(serviceToken.getRealm(), "", searchBarCode, SearchEntity.class,serviceToken.getToken());
			/* Save Session Search in cache , ideally this should be in OutputParam and saved to workflow */
			VertxUtils.putObject(serviceToken.getRealm(), "", sessionSearchCode, searchBE, serviceToken.getToken());
		}
		
		
		searchBE.addFilter("PRI_NAME",SearchEntity.StringFilter.LIKE,"%"+searchBarString+"%");
		
  	     
 		TableUtils.performSearch(serviceToken , beUtils, searchBE);
  	     
  	     /* Send to front end */
   	     
  	     output.setFormCode("FRM_TABLE_VIEW","FRM_CONTENT");
		retract(answer);
	
end
