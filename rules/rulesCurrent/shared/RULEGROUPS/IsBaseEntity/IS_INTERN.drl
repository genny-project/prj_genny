package life.genny.rules;
global life.genny.qwanda.message.QBulkMessage payload;

import life.genny.qwanda.message.QDataAnswerMessage;
import life.genny.models.GennyToken;
import life.genny.rules.QRules;
import life.genny.utils.BaseEntityUtils;
import life.genny.qwanda.Answer;
import life.genny.qwanda.entity.BaseEntity;
import life.genny.utils.OutputParam;
import life.genny.qwanda.entity.BaseEntity;
import life.genny.qwanda.message.QDataBaseEntityMessage;
import life.genny.qwanda.message.QBulkMessage;

import java.util.List;
import java.util.ArrayList;

rule "IS_INTERN"
    ruleflow-group 'IsBaseEntity'
    no-loop true
    salience 1 
    when
	 	userToken : GennyToken (code != "PER_SERVICE" )
		serviceToken : GennyToken (code == "PER_SERVICE" )
		output : OutputParam()
		baseEntityType : String(baseEntityType.equals("Intern"))
		newBe : BaseEntity()
		beUtils : BaseEntityUtils();
	  
     then
 		System.out.println("IS_INTERN: Rule fired" );
 		System.out.println("IS_INTERN: newBe = " + newBe.getCode()); 
 		
 		/* Now we have some details we can create a proper Intern be with an emaily code */
 		String internCode = "PER_"+QwandaUtils.getNormalisedUsername(newBe.getValue("PRI_EMAIL").get());
 		BaseEntity intern = beUtils.create(internCode,newBe.getValue("PRI_NAME").get());
 		
 		
 	/*  Construct answer with Source, Target, Attribute Code, Value */
 		Answer answer = new Answer(userToken.getUserCode(), internCode ,"PRI_IS_INTERN", "true");
 		Answer answer2 = new Answer(userToken.getUserCode(), internCode ,"PRI_STATUS", "AVAILABLE");
 		Answer answer3 = new Answer(userToken.getUserCode(), internCode,"PRI_DISABLED", "false");
 		Answer answerCardColour = new Answer(userToken.getUserCode(),internCode,"PRI_STATUS_COLOR","#5cb85c");
 		
 		/* 		Answer answer = new Answer(userToken.getUserCode(), newBe.getCode() ,"PRI_IS_INTERN", "true");
 		Answer answer2 = new Answer(userToken.getUserCode(), newBe.getCode() ,"PRI_STATUS", "AVAILABLE");
 		Answer answer3 = new Answer(userToken.getUserCode(), newBe.getCode(),"PRI_DISABLED", "false");
 		Answer answerCardColour = new Answer(userToken.getUserCode(),newBe.getCode(),"PRI_STATUS_COLOR","#5cb85c");
 */
 		
 	/*	BaseEntityUtils beUtils = new BaseEntityUtils(userToken); */
 		beUtils.saveAnswer(answer);
 		beUtils.saveAnswer(answer2);
 		beUtils.saveAnswer(answer3);
 		beUtils.saveAnswer(answerCardColour);

		System.out.println("IS_INTERN: Answer = " + answer);
		System.out.println("IS_INTERN: Answer = " + answer2); 
		System.out.println("IS_INTERN: Answer = " + answer3); 
		System.out.println("IS_INTERN: Answer = " + answerCardColour); 
		
		output.setTypeOfResult("NONE");
  	    output.setResultCode("NONE");  /* dont display anything new */
		
		QDataBaseEntityMessage internMsg = new QDataBaseEntityMessage(intern);
		internMsg.setAliasCode("INTERN");	
		payload.add(internMsg);
		
		retract(newBe)
	
end
